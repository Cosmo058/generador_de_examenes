<!DOCTYPE html>
<html>
  <head>
    <title>Generador de ex&aacute;menes</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.debug.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="assets/js/html2canvas.js"></script>
    <script src="assets/js/html2pdf.js"></script>
    <script src="assets/js/funciones.js"></script>
    <script src="assets/js/controller.js"></script>
    

    <script>
      $(document).keypress(function(e) { //EventListener DEBUG
	if(e.which === 13) {
	  
	  var idsReactivos = [];
	  $("input:checked").each(function(){
	    idsReactivos.push($(this).attr("id"));
	  });
	  
	  for(var selected in idsReactivos){
	    ;//alert(idsReactivos[selected].split("_"));
	  }
	  
	  var pdf = new jsPDF('p', 'pt', 'letter');
	  var canvas = pdf.canvas;
	  var width = 600;
	  //canvas.width=8.5*72;
	  document.body.style.width=width + "px";
	  html2canvas(document.body, {
	      canvas:canvas,
	      onrendered: function(canvas) {
		pdf.save("a.pdf");
	      }
	  });
	}
      });
      
      $(document).ready(function(){
	
	$.getJSON("assets/data/data.json", function(data){
	  $.each(data,function(key,val){
	    $.each(val,function(k,v){
	      if(k==="nombreAE"){
		$("#ae_container").append("<div class='card' idAE="+key+"><div class='franja_tarjeta'></div><div class='card_content'><span>"+v+"</span></div></div>");
	      }
	      
	      var reactivos = [];
	      
	      if(typeof v === 'object' && k=== "reactivos"){ //∂
		reactivos = getValuesOf(v,"reactivo"); //Obtener la lista de reactivos del AE en cuestion[key,val]
		
		var tmp_html = "";
		for(var reactivo in v){
		  tmp_html = "<div idAE="+key+" idReactivo="+reactivo+">";
		  //Agregando preguntas al DOM...
		  tmp_html += "<span class='collapsed' idAE="+key+" idReactivo="+reactivo+">"+reactivos[reactivo]+"<br/><br/></span>";
		  
		  //Agregando respuestas al DOM...
		  for(var respuesta in v[reactivo]["respuestas"]){
		    //alert("AE"+key+"_"+reactivo+"_"+respuesta+": "+v[reactivo]["respuestas"][respuesta]); //Obtener el listado de respuestas del AE
		    tmp_html+=" <span class='collapsed' idAE="+key+" idReactivo="+reactivo+" idRespuesta="+respuesta+">"+
						      respuesta+": "+v[reactivo]["respuestas"][respuesta]+
						    "<br\></span>";
		  }
		  tmp_html += "</div>";
		  $("#preview_reactivo").append(tmp_html);
		}
		
	      }
	      
	      if(reactivos !== "")
		for(var i in reactivos){
		  $("#reactivos").append("<div class='card2 collapsed' idAE="+key+" idReactivo="+i+">\
					    <div class='franja_tarjeta'></div>\
					    <div class='card_content'>\
					      <div class='checkbox_div'>\
						<input type='checkbox' id='"+key+"_"+i+"'/>\
						<label for='"+key+"_"+i+"'></label>\
					      </div>\
					      <div class='pregunta_div'>\
						<span>"+reactivos[i]+"</span>\
					      </div>\
					    </div>\
					  </div>");
		}
	    });
	  });
	});
	
	$(document).ajaxComplete(function(){
	  centrar_tarjetas();
	  igualar_altura_logos();
	  mostrar_ancho(); //DEBUG
	
	  $('#ae_container .card').click(function(){ //Go to reactivos
	    var text = $(this).find(".card_content").html();
	    var idAE = $(this).attr("idAE");
	    $("#ae_container").toggle();
	    $("#title").toggle();
	    $("#ae_seleccionado").toggleClass("collapsed col-md-2");
	    $("#ae_sub").toggleClass("collapsed col-md-10");
	    $("#ae_seleccionado > div:not(.circle)").html(text);
	    
	    $(".card2").each(function(index){
	      if( $(this).attr("idAE") === idAE ){
		$(".card2[idAE="+$(this).attr("idAE")+"]").removeClass("collapsed");
	      }
	    });
	  });

	  $(".circle").click(function(){ //Back to AE
	    $("#ae_container").toggle();
	    $("#title").toggle();
	    $("#ae_seleccionado").toggleClass("col-md-2 collapsed");
	    $("#ae_sub").toggleClass("col-md-10 collapsed");
	    $(".card2").each(function(index){ //Hide all card2
	      $(this).addClass("collapsed");
	    });
	  });

	  $(".pregunta_div").click(function(){
	    $("#reactivos").toggleClass("col-md-12 col-md-8");
	    $("#preview_reactivo").toggleClass("collapsed col-md-4");
	    
	    var idAE = $(this).parent().parent().attr("idAE");
	    var idReactivo = $(this).parent().parent().attr("idReactivo");
	    
	    //alert(idAE+"_"+idReactivo);
	    
	    $("#preview_reactivo span").each(function(){
	      //alert( $(this).attr("idAE")+"_"+$(this).attr("idReactivo") );
	      if( $(this).attr("idAE") === idAE && $(this).attr("idReactivo") === idReactivo ){
		$(this).removeClass("collapsed");
	      }else{
		$(this).addClass("collapsed");
	      }
	    });
	  });

	  $("input").click(function(){
	    $(this).siblings("label").toggleClass("red_background");
	    $("#num_reactivos").html($("input:checkbox:checked").length+" reactivos elegidos");
	  });
	  
	  
	  
	}); //End of AjaxCallCompleted
	
        $(window).resize(function(){
          centrar_tarjetas();
          igualar_altura_logos();
          mostrar_ancho(); //DEBUG
        });
      });
    </script>
  </head>

  <body>
    <div class="container">

      <!-- Header -->
      <div class="row" id="header">
        <div class="col-md-2" id="logo_castillo_container">
            <img src="assets/img/logo/logo_castillo.png" alt="logo_castillo">
        </div>
        <div class="col-md-7"></div>
        <div class="col-md-3">
          <div id="materia_section">
            <div id="materia_title">
              <span>Biolog&iacute;a</span>
            </div>
            <div style="margin-left: 110px;">  <!-- TODO -->
              <div id="logo_reactivos">
                <img src="assets/img/reactivos_seleccionados.png">
              </div>
              <div id="num_reactivos">0 reactivos elegidos</div>
            </div>
          </div>
        </div>
      </div>
     <!--/Header-->

     <!--Title-->
      <div class="row">
        <div class="col-md-12" id="title">
          <h3>Generador de ex&aacute;menes</h3>
          <p>Aprendizajes esperados</p>
        </div>
      </div>
      <!--/Title-->

      <!--Main content-->
      <div class="row" id="main_content">
        <!--Cards-->
        <div class="col-md-12" id="ae_container"></div>
        <!--/Cards-->
        <div class="collapsed" id="ae_seleccionado"> <!-- col-md-2 -->
          <div id="sidebar_text">
          </div>
          <div class="circle">
            <button class="arrow">
              <svg viewBox="-5 0 100 80" xml:space="preserve">
                <polyline points="45.63,75.8 0.375,38.087 45.63,0.375"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="collapsed" id="ae_sub">
          <div class="row">
            <div class="col-md-12" id="reactivos"> <!-- col-md-10 -->
	      <!--
              <div class="card2">
                <div class="franja_tarjeta"></div>
                <div class="card_content">
                  <div class="checkbox_div">
                    <input type="checkbox" id="checkboxInput"/>
                    <label for="checkboxInput"></label>
                  </div>
                  <div class="pregunta_div">
                    <span>Mucho texto aquí, mucho texto allá</span>
                  </div>
                </div>
              </div>
	      -->
            </div>
            <div class="collapsed" id="preview_reactivo">
              <!--<span>Hola, soy un reactivo</span>-->
            </div>
          </div>
        </div>
      </div>
      <!--/Main content-->

      <!--Footer-->
      <div class="row">
        <div class="col-md-12" id="footer">
          D.R. &copy; 2017 | Ediciones Castillo, S.A. de C.V. <br/>
          TODOS LOS DERECHOS RESERVADOS
        </div>
      </div>
      <!--/Footer-->
    </div>
  </body>
</html>
